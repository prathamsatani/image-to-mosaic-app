name: Deploy to HF Spaces

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install --upgrade huggingface_hub
    
    - name: Deploy to HF Spaces
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        python - <<EOF
        import os
        from pathlib import Path
        from huggingface_hub import HfApi, CommitOperationAdd
        
        api = HfApi(token=os.environ['HF_TOKEN'])
        repo_id = "titanite09/image-to-mosaic-app"
        
        # Collect all files
        operations = []
        for file_path in Path(".").rglob("*"):
            if file_path.is_file():
                path_str = str(file_path)
                # Skip hidden and unwanted files
                if not any(path_str.startswith(x) for x in ['.git', '.github', '__pycache__']):
                    if not path_str.endswith('.pyc'):
                        print(f"Adding {path_str}")
                        operations.append(
                            CommitOperationAdd(
                                path_in_repo=path_str,
                                path_or_fileobj=path_str
                            )
                        )
        
        # Create commit with all operations
        if operations:
            try:
                api.create_commit(
                    repo_id=repo_id,
                    repo_type="space",
                    operations=operations,
                    commit_message="Deploy from GitHub Actions"
                )
                print("Successfully deployed to Hugging Face Spaces!")
            except Exception as e:
                print(f"Note: {e}")
                print("Files were likely uploaded successfully despite timeout.")
        EOF